# Robinhood ACE



---

1.  Function requirement :

Check the account statement

Trade the stock with market order



![](../../media/Payment^JTrade-Stock-Robinhood-ACE-image1.png)



![功 能 性 需 求 非 功 能 性 需 求 2 · 2 理 解 需 求 查 询 账 户 状 态 并 下 单 买 卖 股 票 (MarketOrder) 外 部 交 易 所 （ Na aq ） 提 供 API 下 单 / 查 词 订 单 状 态 高 一 致 性 ， 券 商 账 户 状 态 和 交 易 所 订 单 状 态 一 致 高 扩 展 性 ， 支 持 分 布 式 高 值 流 量 ](../../media/Payment^JTrade-Stock-Robinhood-ACE-image2.png)





![交 易 所 1 GET / VI / 。 e /vl/orders ](../../media/Payment^JTrade-Stock-Robinhood-ACE-image3.png)











![API Response // Order Object "id". 904837e3-3b76-47ec-b432-e46db621571b", '"client order id": 9e4837e3-3b76-47ec-b432-ø46db621571b", "asset id": "9Ø4837e3-3b76-47ec-b432-046db621571b", symbol": "AAPL", "asset class": "us_equity" "qty": "15", "filled_qty" : '"type": "market" "side": "buy", "status . "accepted", "created at" " : 2e18-1e-ø5Tø5:48: , "'updated _ at " " submitted at "filled at": " expired_at " "canceled at • " "failed_at • " ](../../media/Payment^JTrade-Stock-Robinhood-ACE-image4.png)

After call POST API, the result will not return immediately



We need to call GET API

In some frequency

APT to check the status of the Order





Or after we call the POST









![](../../media/Payment^JTrade-Stock-Robinhood-ACE-image5.png)



id is object id

and client order id is client id generated by client side and we can query the status of order by using client id

![假 设 瓶 颈 服 务 资 源 存 储 资 源 2 ． 3 资 源 估 算 每 天 下 单 量 1M 下 单 量 会 大 幅 波 动 （ 1 ） 看 盘 量 每 天 1 M 10M 账 户 Write QPS 一 10 / （ 36 24 ） 、 = 120 Read QPS 一 1 M * 10 / （ 36 佣 * 24 ） ： 12 佣 Transaction DB 一 1M 1 B 5 365 = 18 B Account DB 10M * IKB = 1 B ](../../media/Payment^JTrade-Stock-Robinhood-ACE-image6.png)

1m = 12/qps



![له١عاد8 مخوصا --حا) (يام ج) .acec.öÅefn±e,cvc•eu u) حن. ه مدن عمو جم؟ له مه ن -Q RcC لي ه ما PB ](../../media/Payment^JTrade-Stock-Robinhood-ACE-image7.png)



account service will check the status of the account

order service will place the order











![田 考 题 七 如 何 避 免 用 户 连 续 下 单 造 成 账 户 余 额 不 足 ？ 在 用 户 下 单 到 交 易 完 成 这 段 时 间 里 ， 将 即 将 交 易 的 现 金 和 股 票 预 留 下 来 。 ](../../media/Payment^JTrade-Stock-Robinhood-ACE-image8.png)



![¯čRłnc-čS Vł -a.ppdn@ @rogo q p -am S/HSbD anrasa-i @ ±ȚJO O ](../../media/Payment^JTrade-Stock-Robinhood-ACE-image9.png)

1.  place order
2.  [reserve cash/share]{.mark}
3.  [update account db about 2]{.mark}
4.  forward order
5.  [add accepted order to ledger]{.mark}
6.  queue up order
7.  Worker on another side will forward and submit order and return a ack
8.  [update order status to new]{.mark}
9.  check order status and return filled
10. [update order status to filled]{.mark}
11. update account balance in account db

![](../../media/Payment^JTrade-Stock-Robinhood-ACE-image10.png)



![](../../media/Payment^JTrade-Stock-Robinhood-ACE-image11.png)



Step 4, 6 and 7 could be time out or error

We need to keep consistency between :

![Distributed Transaction Account DB Ledger Execution Venue ](../../media/Payment^JTrade-Stock-Robinhood-ACE-image12.png)

need make sure account DB

ledger db and execution venue

consistency





All the action will send event or log to Kafka (like write ahead log) and Kafka will forward to watchdog, or watchdog will read the event from Kafak. there is a cron job in watchdog and if there are any invalid from step 1- 4. it will undo the transaction

![Saga structure: 3 phases Compensatable transactions Pivot transaction = GO/NO GO Retriable transactbns that can't fail Tn+2 and don't need compensation reat for ætions that cannot be ](../../media/Payment^JTrade-Stock-Robinhood-ACE-image13.png)

saga pattern will do each action in sequency



if some action failed it will undo or retried those actions



there are 4 types of transactions in the saga pattern: transaction, undo/compensable transaction and pivot transaction and retriable transaction



after all compensable transaction done, we can go to the pivot transaction

T1 can be rollback -- C1



Pivot transaction cannot rollback and cannot re-try



After pivot no transaction can be rollback



Retriable transaction cannot rollback but can re-try

![券 商 系 统 与 saga Cl C2 PivotT3 Retriable T4 Retriable T5 券 商 预 留 资 金 / 股 票 券 商 解 除 预 留 券 商 确 认 订 单 券 商 取 消 订 单 交 易 所 执 行 订 单 券 商 更 新 订 单 状 态 券 商 更 新 账 户 状 态 ](../../media/Payment^JTrade-Stock-Robinhood-ACE-image14.png)

1.  place order
2.  [reserve cash/share]{.mark}
3.  [update account db about 2]{.mark}
4.  forward order
5.  [add accepted order to ledger]{.mark}
6.  queue up order
7.  Worker on another side will forward and submit order and return a ack
8.  [update order status to new]{.mark}
9.  check order status and return filled
10. [update order status to filled]{.mark}
11. update account balance in account db

T1 -- (2+3)

C2 undo those reservation



4



T2 -- 5

C2

6



T4 -- 8,10

9

T5 - 11





after T1 successful, in a certain timeframe, if the watchdog didnot hear anything for T2, it will undo the T1



after T2 successful, in certain timeframe, if the dogwatch didnot hear anything for Pivot T3, it will undo the T2



if T4 unsuccessful, watchdog will retry T4 ..













![](../../media/Payment^JTrade-Stock-Robinhood-ACE-image11.png)



Pivot transaction, we cannot just retry, we need to collect some additional information

Like if the 交易所 是不是 有问题， 先询问交易所能不能再执行订单...





Database design





![account_entries account-id asset_id asset_class quatity UI-no asset_class varchar float8 account_id order_id external_order _id asset_id asset. class symbol quatJty uUID UU'D uu'0 har transaction_type price external account id created_at submitted at filled_at canceled_at completed _at uU'D timestamp t.mestamp timestamp timestamp Status trmsoctton_status accepted ecnceted co---p et ed ](../../media/Payment^JTrade-Stock-Robinhood-ACE-image15.png)

<https://docs.google.com/drawings/d/14PqzlioFNqoaaApA5t3UezEY55Aj6DimFe6gRynFNUs/edit>

![Account id I user id I balance I timestamp User LB Account DB Account service 1 .Place a order 2, Reverse credit + 3. update the table 11 .update the account 4. Submit the order to order service status Watch dog Forward 1, 2, 11 watch dog External Payment service Order service + queue 7. Forward the order and eturn ack 9. Check the order status periodically 5. Add new order to ledger 6. Queue up the new order 8. Update the order status to new 10. Up date the order to filled Order id I user id I account id I charity id I amo Create at I summit at I complete at I cancel at I nt I status 8 to ](../../media/Payment^JTrade-Stock-Robinhood-ACE-image16.png)


















