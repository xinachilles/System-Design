# Summary -ACE



---

![AC 老 功 能 性 需 求 非 功 能 性 非 需 求 1 ． 2 理 解 需 求 基 于 流 行 关 键 词 进 行 补 全 （ 搜 索 次 数 越 多 ， 搜 索 越 新 ， 越 流 行 ） 补 全 选 项 至 多 10 个 用 户 体 验 极 低 延 迟 ， 延 迟 低 于 本 地 打 字 速 度 自 动 补 全 基 于 的 数 据 更 新 允 许 一 小 时 的 延 迟 可 靠 性 ， 补 全 的 关 键 词 的 流 行 程 度 为 前 十 高 扩 展 性 ， 亿 级 DAU 拼 写 检 查 ， 非 英 文 支 持 ， 个 性 化 补 全 ](../../media/Steam^JCollection-Typehead-Summary--ACE-image1.png)

**[Function Requirement]{.mark}**

If user type something, system should suggest top 10 terms starting with base on user has typed.

[need ask the time frame for the top 10]{.mark}

top 10 data should be updated every hour or every data or every year





[Non-function requirement]{.mark}

Scalable

Latency is impart for us, search typehead need compete with the typing spread

need to have low latency



Highly available

How import the available

Very important. If search typeahead is not available, the site would still keep working. However, it will lead to a much degraded experience.



The popularity should be update every hour





![假 设 瓶 颈 服 务 资 源 1 ． 3 资 源 估 算 IBDAU 每 人 每 天 平 均 进 行 10 次 搜 索 每 次 搜 索 发 出 5 次 补 全 请 求 读 写 QPS 读 QPS 一 1B 5 / （ 24 36 闐 ） 、 一 Ok 写 QPS 一 0 / （ 24 36 闐 ） 、 = 120k ](../../media/Steam^JCollection-Typehead-Summary--ACE-image2.png)

![0 关 键 词 采 集 计 数 数 据 流 补 全 预 处 理 处 理 补 全 请 求 ](../../media/Steam^JCollection-Typehead-Summary--ACE-image3.png)



![e- *asa vpo--oS qac quo @ 1/1'D-noaS ](../../media/Steam^JCollection-Typehead-Summary--ACE-image4.png)



**The System can be divided into 2 part: Data collection, the system will** ﻿gathers user input queries and aggregates and calculate the top 10





﻿Query service: Given a search query or prefix, return 10 most frequently searched terms.







![思 考 题 关 键 词 计 数 选 择 stream Processing 还 是 M 叩 R e ？ 根 据 实 时 性 要 求 ， 选 择 MapReduce ](../../media/Steam^JCollection-Typehead-Summary--ACE-image5.png)



1.  [Data collection]{.mark}



![关 键 词 采 集 计 数 搜 索 关 键 词 MapReduce 进 Kafka 消 息 发 出 行 计 数 ](../../media/Steam^JCollection-Typehead-Summary--ACE-image6.png)



Kafka event : search key word and time stamp

System will store the [kafka event]{.mark} to the hive table -- data warehouse storage

May reduce job will run very hour to count those key word and update each word's popularity score in DB.



There are two ways to build each prefix top 10 words



1.  Use tire builder: we each leaf nodes's top 10 words and recursive from bottom to top
2.  Then we can dump the each node to generate a hash map key is each prefix keyword and value is to 10 words for this keywords---?





Finally MapReduce will store the calculation in the DB

Keyword/prefix word -> top10 ... A list of top 10 { word/prefix word , score }





![流 行 指 数 计 算 对 于 每 一 个 关 键 词 新 流 行 指 数 ： 旧 流 行 指 数 * 0 · 99 + 一 分 钟 内 的 访 问 次 数 ](../../media/Steam^JCollection-Typehead-Summary--ACE-image7.png)





We just need to calculate within 1 minutes, how many this key word was searched then the new result = old result *0.99+ the number of search in 1 minutes

We can move all the history data to a history database

If we decided to change the 0.99 to 0.98 or 0.97 later, we can re-calculate the number base on the history data



3.  Auto complete

Trie solution -- we can build the trie from leaf to root, base on {word, score } table generated by MapReduce



![* some scores omitted for presentation purposes root c (car: 30, [cold, coin, cod, [car, cart J* car cart ca [cart] * : cart: 10, cat :901 cat cod cart. car) * co coi coin cat, col cold ](../../media/Steam^JCollection-Typehead-Summary--ACE-image8.png)



Each node has top 10 node for this prefix



[Hash table solution]{.mark}

![](../../media/Steam^JCollection-Typehead-Summary--ACE-image9.png)





![Trie vs HashTab1e Trie Hash Table Read 0(1) Disk Usage Less More Distributed System Custom Distributed Cache ](../../media/Steam^JCollection-Typehead-Summary--ACE-image10.png)

Trie solution Is not easy sharding, hash table has distributed cache solution



**How to store Trie in a file so that we can rebuild our trie easily - this will be needed when a machine restarts?**

**------------------------------------------------------------------**

**a. Range Based Partitioning:** What if we store our phrases in separate partitions based on their first letter. So we save all the terms starting with letter 'A' in one partition and those that start with letter 'B' into another partition and so on.

We can even combine certain less frequently occurring letters into one database partition.

[**Partition based on the hash of the term:** Each term will be passed to a hash function, which will generate a server number and we will store the term on that server.]{.mark}

[This will make our term distribution random and minimizing hotspots.]{.mark}

To find typeahead suggestions for a term, we have to ask all servers and then aggregate the results. We have to use consistent hashing for fault tolerance and load distribution.

For hot word--- we can user master slaver structure

















![思 考 题 用 户 每 打 一 个 字 母 都 发 一 个 Request 吗 ？ 出 现 短 暂 停 顿 时 预 加 载 ](../../media/Steam^JCollection-Typehead-Summary--ACE-image11.png)



[Prefetch]{.mark} --- Predict by service, assume user will key next time



![Autocomplete (Redis) Prefix Top Ten Popular Autocomplete ](../../media/Steam^JCollection-Typehead-Summary--ACE-image12.png)



![Autocomplete // Request GET /vl/autocomplete?prefix=th // Response keywords: [ "thank" , "thing" , prefetch: { "thea" : "theatre" , ](../../media/Steam^JCollection-Typehead-Summary--ACE-image13.png)







![服 务 器 存 储 1.8 扩 展 性 Kafka Event Bus ， MapReduce 分 布 式 缓 存 ， 分 布 式 数 据 库 ](../../media/Steam^JCollection-Typehead-Summary--ACE-image14.png)





![Autocomplete Latency 1.10 Data Update Cache Capacity Latency ](../../media/Steam^JCollection-Typehead-Summary--ACE-image15.png)



![思 考 题 如 何 高 效 生 成 每 个 前 缀 的 前 十 流 行 关 诞 词 ？ MapReduce Trie Builder ](../../media/Steam^JCollection-Typehead-Summary--ACE-image16.png)



Data update latency

MapReduce job + trie builder

When last time data update



![服 务 器 存 储 1 ． 9 容 灾 设 计 MapReduce Replication ()B ， Cache) ](../../media/Steam^JCollection-Typehead-Summary--ACE-image17.png)

















